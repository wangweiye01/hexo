---
title: 扫描二维码（登录，支付）后立即通知
date: 2018-03-05 10:48:42
tags:
---

> 最近在做微信的扫码支付，遇到一个问题：如何在用户扫码支付完成之后，客户端立即得到通知，进行下一步的跳转？

首先想到的策略可能是客户端轮询查询订单状态，根据返回结果进行跳转

这个方式有明显的缺点，轮询时间设置短，频繁发送请求，对服务器以及数据库都会产生压力；轮询时间过长，用户等待时间长，体验很差；

针对这个问题想到了微信网页版的扫码登录（扫码完成后，立即登录），现在看一下它的实现过程

# 微信扫码登录原理

![pengding](http://www.wailian.work/images/2018/03/05/pending.png)

根据图片中，前端二维码页面发送一个网络请求，但是这个请求并没有立即返回

![408](http://www.wailian.work/images/2018/03/05/408.png)

一段时间没有扫描后，后端返回408，前端重新发起一个相同的网络请求，并继续pending

据此猜测大概实现原理如下：

1. 进入网站-生成一个唯一标识(比如UUID)
2. 跳转到二维码页面（二维码中的链接包含次UUID）
3. 二维码页面向服务端发起请求，查询二维码是被扫登录
4. 服务器收到请求，查询。如果未扫登录，进入等待(wait)，不立即返回
5. 一旦被扫，立即返回(notify)
6. 页面收到结果，做后续处理

步骤大概就是如此，但是有个问题，步骤3如果请求超时，如何处理？处理方式是，一段固定时间后，返回408（timeout）


对比[代码](https://github.com/wangweiye01/scan_login)很容易看实现原理
